<!DOCTYPE html>
<html lang="en">
<head>
  <title>{{title}}</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

</head>
<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>



  <script src="http://mozilla.github.io/nunjucks/files/nunjucks.min.js"></script>

  <!-- Google One-tap sign-up and auto sign-in on websites
       https://developers.google.com/identity/one-tap/web/get-started -->
  <script src="https://smartlock.google.com/client"></script>

  <script type="text/javascript">
    window.isSignedIn = {{ isSignedIn }};
    console.log('isSignedIn: ', {{ isSignedIn }});

    // define a generic Ajax error handler:
    // http://api.jquery.com/ajaxerror/
    $(document).ajaxError(() => {
      console.log('Error: unknown ajaxError');
    });

    function useGoogleIdTokenForAuth(idToken) {
      $.ajax({
        url : 'idTokenLogin',
        type: 'POST',
        data: {
          idToken: idToken
        },
        success: (data) => {
          console.log('idTokenLogin: success');
          $('#loginNav').hide();
          $('#logoutNav').show();
          //window.location.reload();

        }
      });
    }

    const PUBLIC_CLIENT_ID = '687083663797-h6rk9pcjjm2ac1kib7kcbbjqpqc2ipcg.apps.googleusercontent.com'
    // CONFIG documentation: https://developers.google.com/identity/one-tap/web/retrieve-credentials
    const CONFIG = {
      supportedAuthMethods: [
        'https://accounts.google.com'
      ],
      supportedIdTokenProviders: [
        {
          uri: 'https://accounts.google.com',
          clientId: PUBLIC_CLIENT_ID
        }
      ]
    };
    // onLoad callback, try to retrieve credential
    window.onGoogleYoloLoad = (googleyolo) => {
      console.log("GoogleYolo loaded.");

      if (window.isSignedIn) {
        console.log('is signed in, escape automatical login');
        return;
      }

      const retrievePromise = googleyolo.retrieve(CONFIG);
      // The googleyolo.retrieve() method returns a Promise that resolves when
      // the request has completed. Attach a resolution function to the Promise
      // to handle the credential if one was retrieved.
      retrievePromise.then((credential) => {
        if (credential.password) {
          // An ID (usually email address) and password credential was retrieved.
          // Sign in to your backend using the password.
          // signInWithEmailAndPassword(credential.id, credential.password);
          console.log('credential.id:', credential.id, 'credential.password:', credential.password);
        } else {
          // A Google Account is retrieved. Since Google supports ID token
          // responses, you can use the token to sign in instead of initiating
          // the Google sign-in flow.

          // console.log('credential.idToken:', credential.idToken);
          useGoogleIdTokenForAuth(credential.idToken);
        }
      }, (error) => {
        // Credentials could not be retrieved. In general, if the user does not
        // need to be signed in to use the page, you can just fail silently; or,
        // you can also examine the error object to handle specific error cases.
        console.log('Silent Fail:', error);
        // If retrieval failed because there were no credentials available, and
        // signing in might be useful or is required to proceed from this page,
        // you can call `hint()` to prompt the user to select an account to sign
        // in or sign up with.
        /*
        if (error.type === 'noCredentialsAvailable') {
          googleyolo.hint(...).then(...);
        }
        */
      });
    };

    $(document).ready(() => {
      if (window.isSignedIn) {
        $('#loginNav').hide();
        $('#logoutNav').show();
      } else {
        $('#loginNav').show();
        $('#logoutNav').hide();
      }
      $('#loginNav').click(() => {
        googleyolo.hint(CONFIG).then((credential) => {
          if (credential.password) {
            console.log('credential.id:', credential.id, 'credential.password:', credential.password);
          } else {
            // console.log('credential.idToken:', credential.idToken);
            useGoogleIdTokenForAuth(credential.idToken);
          }
        }, (error) => {
          console.log("Silent Fail:", error);
        });
      });
      $('#logoutNav').click(() => {
        googleyolo.disableAutoSignIn().then(() => {
          // Auto sign-in disabled.
          console.log('Logout: Auto sign-in disabled.');
        });
        $.ajax({
          url : 'logout',
          type: 'POST',
          success: () => {
            console.log('/logout POST success');
            $('#loginNav').show();
            $('#logoutNav').hide();
            //window.location.reload();
          }
        });
      });
    });
  </script>
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="padding: 1em 5em 1em;">
      <a class="navbar-brand" href="/">Here-n-There</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="navbar-collapse collapse w-100 order-1 order-md-0 dual-collapse2">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="/locations">Locations</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/about">About</a>
          </li>
        </ul>
      </div>
<!--
      <div class="form-inline">
        <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success my-2 my-sm-0">Search</button>
      </div>
-->
      <div class="navbar-collapse collapse w-100 order-3 dual-collapse2">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a class="dropdown-toggle" id='dropdownToggle' href='#' data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <img src="/img/meme.jpg" alt="Avatar" style="border-radius: 50%; height: 3em;">
              <scan class="caret"></scan>
            </a>
            <div class="dropdown-menu" role="menu" aria-labelledby="dropdownToggle">
              <a class="dropdown-item" href="/profile">View My Profile</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item"><button class="btn btn-primary" id="loginNav">Login</button></a>
              <a class="dropdown-item"><button class="btn btn-danger" id="logoutNav">Logout</button></a>
            </div>
          </li>
        </ul>
      </div>

    </nav>
  </header>
  <div class="container">
    <!-- Flash massages -->
    {% if flash %}
    {% for type, message in flash %}
    <ul>
      <div class="alert alert-{{ type }}">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        {{ message }}
      </div>
    </ul>
    {% endfor %}
    {% endif %}
    <!-- Below goes every page of the wesites -->
    {% block body %}
    {% endblock %}
  </div>



  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
</body>
</html>
